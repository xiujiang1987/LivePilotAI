============================= test session starts =============================
platform win32 -- Python 3.12.9, pytest-9.0.2, pluggy-1.6.0
rootdir: D:\Workspace\03.Dev_Projects\ai\LivePilotAI
configfile: pyproject.toml
plugins: anyio-4.12.0, asyncio-1.3.0, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 1 item

tests\integration\api_main_test.py F                                     [100%]

================================== FAILURES ===================================
_____________________ test_api_integration_with_main_app ______________________

self = <main.LivePilotAIApp object at 0x000002732D161C10>

    def _start_api_server(self):
        """Start the FastAPI server in a background thread"""
        try:
>           self.logger.info("Starting API server on port 8000...")
            ^^^^^^^^^^^
E           AttributeError: 'LivePilotAIApp' object has no attribute 'logger'

main.py:282: AttributeError

During handling of the above exception, another exception occurred:

    def test_api_integration_with_main_app():
        """Test that the API server starts and runs properly inside LivePilotAIApp"""
        # Import inside the test to avoid Tkinter issues during collection
        from main import LivePilotAIApp
        import tkinter as tk
    
        # Initialize basic app structure without launching full mainloop
        root = tk.Tk()
    
        try:
            app = LivePilotAIApp()
    
            # We only call _start_api_server instead of initialize to avoid
            # loading heavylifting camera/AI components inside tests
            # Bind root manually
            app.root = root
    
            # 模擬 _init_components 的一些行為，避免依賴模型權重
            from src.api.server import app as fastapi_app
            fastapi_app.state.main_app = app
            app.is_running = True
    
            # Start API server directly
>           app._start_api_server()

tests\integration\api_main_test.py:29: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <main.LivePilotAIApp object at 0x000002732D161C10>

    def _start_api_server(self):
        """Start the FastAPI server in a background thread"""
        try:
            self.logger.info("Starting API server on port 8000...")
    
            # Use dynamic import to get the latest app instance
            from src.api.server import app as fastapi_app
            # Attach main app instance to FastAPI state
            fastapi_app.state.main_app = self
    
            def run_server():
                uvicorn.run(
                    fastapi_app,
                    host="0.0.0.0",
                    port=8000,
                    log_level="error"
                )
    
            self.api_thread = threading.Thread(target=run_server, daemon=True)
            self.api_thread.start()
            self.logger.info("API server is running in background.")
        except Exception as e:
>           self.logger.error(f"Failed to start API server: {e}")
            ^^^^^^^^^^^
E           AttributeError: 'LivePilotAIApp' object has no attribute 'logger'

main.py:301: AttributeError
=========================== short test summary info ===========================
FAILED tests/integration/api_main_test.py::test_api_integration_with_main_app
============================== 1 failed in 0.91s ==============================
