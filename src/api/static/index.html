<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LivePilotAI æ§åˆ¶å° (v1.1.0)</title>
    <!-- Tailwind CSS (CDN for minimal setup) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .bg-gradient {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pulse-active {
            animation: gently-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes gently-pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body class="bg-gradient text-slate-100 min-h-screen text-sm sm:text-base">
    <div class="container mx-auto p-4 sm:p-6 max-w-6xl">
        <!-- Header -->
        <header
            class="glass-panel rounded-2xl p-6 mb-6 shadow-2xl flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-white tracking-tight flex items-center gap-3">
                    <span class="text-4xl">ğŸ¬</span> LivePilotAI <span
                        class="bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">Control
                        Panel</span>
                </h1>
                <p class="text-slate-400 font-medium mt-1">æ™ºèƒ½ AI å°æ’­èˆ‡æƒ…ç·’ç›£æ§ç³»çµ±</p>
            </div>
            <div class="flex flex-col sm:flex-row gap-4 bg-slate-900/50 p-3 rounded-xl border border-slate-700/50">
                <div class="flex items-center gap-2">
                    <div id="apiStatus"
                        class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]"></div>
                    <span class="text-xs font-semibold uppercase tracking-wider text-slate-300">API æ ¸å¿ƒ</span>
                </div>
                <div class="flex items-center gap-2">
                    <div id="sysStatus"
                        class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]"></div>
                    <span class="text-xs font-semibold uppercase tracking-wider text-slate-300">è¾¨è­˜å¼•æ“</span>
                </div>
                <div class="flex items-center gap-2">
                    <div id="obsStatus"
                        class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]"></div>
                    <span class="text-xs font-semibold uppercase tracking-wider text-slate-300">OBS é€£ç·š</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- Left Column: Emotion Monitor -->
            <div class="lg:col-span-8 flex flex-col gap-6">
                <section class="glass-panel rounded-2xl p-6 shadow-xl flex-grow flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold flex items-center gap-2"><span class="text-2xl">ğŸ­</span> å³æ™‚æƒ…ç·’åˆ†æ
                        </h2>
                        <div
                            class="text-xs font-medium text-slate-400 bg-slate-800 px-3 py-1 rounded-full flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 pulse-active"
                                id="pollingIndicator"></span> Live
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div
                            class="col-span-1 bg-slate-900/50 rounded-xl flex flex-col items-center justify-center p-6 border border-slate-700/50">
                            <div id="emotionEmoji"
                                class="text-7xl mb-2 filter drop-shadow-lg transition-transform duration-300 hover:scale-110">
                                ğŸ˜</div>
                            <h3 id="emotionLabel" class="text-2xl font-black uppercase tracking-widest text-indigo-300">
                                NEUTRAL</h3>
                            <p class="text-xs text-slate-500 mt-2 font-mono" id="emotionConfidence">Conf: --%</p>
                        </div>
                        <div
                            class="col-span-2 relative h-48 sm:h-auto min-h-[12rem] bg-slate-900/30 rounded-xl p-2 border border-slate-700/30">
                            <canvas id="emotionChart"></canvas>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Right Column: Controls -->
            <div class="lg:col-span-4 flex flex-col gap-6">
                <!-- OBS Scene Control -->
                <section class="glass-panel rounded-2xl p-6 shadow-xl">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span class="text-2xl">ğŸ“¹</span> OBS å°æ’­åˆ‡æ›
                    </h2>
                    <p class="text-sm text-slate-400 mb-4">å¼·åˆ¶è¦†è“‹ç›®å‰çš„é¡é ­ä½ˆå±€</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-3 mb-4">
                        <button onclick="switchScene('Gaming')"
                            class="group relative overflow-hidden bg-slate-800 hover:bg-slate-700 border border-slate-600 font-medium py-3 px-4 rounded-xl transition-all duration-300 hover:border-indigo-500 hover:shadow-[0_0_15px_rgba(99,102,241,0.3)]">
                            <div class="flex items-center gap-3 relative z-10"><span class="text-xl">ğŸ®</span>
                                <span>éŠæˆ²ç•«é¢ (Gaming)</span></div>
                            <div
                                class="absolute inset-0 bg-gradient-to-r from-indigo-600/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                            </div>
                        </button>
                        <button onclick="switchScene('Chatting')"
                            class="group relative overflow-hidden bg-slate-800 hover:bg-slate-700 border border-slate-600 font-medium py-3 px-4 rounded-xl transition-all duration-300 hover:border-emerald-500 hover:shadow-[0_0_15px_rgba(16,185,129,0.3)]">
                            <div class="flex items-center gap-3 relative z-10"><span class="text-xl">ğŸ’¬</span>
                                <span>èŠå¤©ä½ˆå±€ (Chatting)</span></div>
                            <div
                                class="absolute inset-0 bg-gradient-to-r from-emerald-600/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                            </div>
                        </button>
                        <button onclick="switchScene('Focused')"
                            class="group relative overflow-hidden bg-slate-800 hover:bg-slate-700 border border-slate-600 font-medium py-3 px-4 rounded-xl transition-all duration-300 hover:border-amber-500 hover:shadow-[0_0_15px_rgba(245,158,11,0.3)]">
                            <div class="flex items-center gap-3 relative z-10"><span class="text-xl">ğŸ¯</span>
                                <span>å°ˆæ³¨ç‰¹å¯« (Focused)</span></div>
                            <div
                                class="absolute inset-0 bg-gradient-to-r from-amber-600/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                            </div>
                        </button>
                        <button onclick="switchScene('Showcase')"
                            class="group relative overflow-hidden bg-slate-800 hover:bg-slate-700 border border-slate-600 font-medium py-3 px-4 rounded-xl transition-all duration-300 hover:border-sky-500 hover:shadow-[0_0_15px_rgba(14,165,233,0.3)]">
                            <div class="flex items-center gap-3 relative z-10"><span class="text-xl">ğŸ“º</span>
                                <span>ç•«é¢å±•ç¤º (Showcase)</span></div>
                            <div
                                class="absolute inset-0 bg-gradient-to-r from-sky-600/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                            </div>
                        </button>
                    </div>
                    <div
                        class="h-8 flex items-center justify-center bg-slate-900/50 rounded-lg border border-slate-700/50">
                        <p id="actionResult" class="text-xs font-medium text-slate-400 tracking-wide"></p>
                    </div>
                </section>

                <!-- System Controls -->
                <section class="glass-panel rounded-2xl p-6 shadow-xl">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span class="text-2xl">âš™ï¸</span> ç³»çµ±ä¿è­·
                    </h2>
                    <div class="flex flex-col gap-3">
                        <button onclick="systemAction('stop_ai')"
                            class="bg-red-500/10 border border-red-500/30 hover:bg-red-500 hover:border-red-400 text-red-400 hover:text-white font-bold py-3 px-4 rounded-xl transition-all duration-300 flex justify-center items-center gap-2 hover:shadow-[0_0_20px_rgba(239,68,68,0.4)]">
                            <span>ğŸ›‘</span> ç·Šæ€¥åœæ­¢ AI å¼•æ“
                        </button>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        const emotionMap = {
            'happy': 'ğŸ˜Š', 'sad': 'ğŸ˜¢', 'angry': 'ğŸ˜ ',
            'fear': 'ğŸ˜¨', 'surprise': 'ğŸ˜²', 'disgust': 'ğŸ¤¢',
            'neutral': 'ğŸ˜'
        };
        const colorMap = {
            'happy': '#f59e0b', 'sad': '#3b82f6', 'angry': '#ef4444',
            'fear': '#8b5cf6', 'surprise': '#10b981', 'disgust': '#84cc16',
            'neutral': '#94a3b8'
        };

        // --- Chart.js Setup ---
        const MAX_DATA_POINTS = 30; // About 15 seconds if polling every 500ms
        const labels = Array(MAX_DATA_POINTS).fill('');
        const datasets = Object.keys(emotionMap).map(emo => ({
            label: emo,
            data: Array(MAX_DATA_POINTS).fill(0),
            borderColor: colorMap[emo],
            backgroundColor: 'transparent',
            borderWidth: window.innerWidth > 640 ? 2 : 1.5,
            tension: 0.4,
            pointRadius: 0,
            hidden: emo === 'neutral' // Hide neutral by default to see others clearly
        }));

        const ctx = document.getElementById('emotionChart').getContext('2d');
        const emotionChart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 }, // Disable animation for smoother realtime updates
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { boxWidth: 8, font: { size: 10, family: 'Inter' }, color: '#cbd5e1' }
                    },
                    tooltip: { enabled: false }
                },
                scales: {
                    x: { display: false },
                    y: {
                        beginAtZero: true,
                        max: 1.0,
                        grid: { color: 'rgba(51, 65, 85, 0.4)' },
                        ticks: { display: false } // Hide Y axis numbers to save space
                    }
                }
            }
        });

        // --- Helper: Update Status Dots ---
        function setStatusLight(id, isOk, colorClass = 'bg-emerald-500', shadowColor = 'rgba(16,185,129,0.8)') {
            const el = document.getElementById(id);
            if (isOk) {
                el.className = `w-2.5 h-2.5 rounded-full ${colorClass} shadow-[0_0_8px_${shadowColor}]`;
            } else {
                el.className = `w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.8)]`;
            }
        }

        async function fetchStatus() {
            try {
                // Check if API is answering
                const healthRes = await fetch(`${API_BASE}/health`, { signal: AbortSignal.timeout(2000) });
                setStatusLight('apiStatus', healthRes.ok);

                // Get System Status
                let sysOk = false, obsOk = false;
                const statusRes = await fetch(`${API_BASE}/status`, { signal: AbortSignal.timeout(2000) });
                if (statusRes.ok) {
                    const status = await statusRes.json();
                    sysOk = status.is_running;
                    obsOk = status.obs_connected;
                    setStatusLight('sysStatus', sysOk);
                    setStatusLight('obsStatus', obsOk, 'bg-emerald-500', 'rgba(16,185,129,0.8)');
                    // Visual tweak if offline but API is up
                    if (!sysOk) document.getElementById('sysStatus').className = `w-2.5 h-2.5 rounded-full bg-slate-500`;
                    if (!obsOk) document.getElementById('obsStatus').className = `w-2.5 h-2.5 rounded-full bg-amber-500 shadow-[0_0_8px_rgba(245,158,11,0.8)]`;
                }

                // Get Emotion data if AI is active
                const emoRes = await fetch(`${API_BASE}/emotion`, { signal: AbortSignal.timeout(2000) });
                if (emoRes.ok) {
                    const emoData = await emoRes.json();
                    const eKey = emoData.dominant_emotion.toLowerCase();

                    // Update Hero Emotion
                    const emojiNode = document.getElementById('emotionEmoji');
                    if (emojiNode.innerText !== emotionMap[eKey]) {
                        // Quick animation on change
                        emojiNode.style.transform = 'scale(1.2) translateY(-10px)';
                        setTimeout(() => emojiNode.style.transform = '', 200);
                    }
                    emojiNode.innerText = emotionMap[eKey] || 'ğŸ¤”';

                    const labelNode = document.getElementById('emotionLabel');
                    labelNode.innerText = eKey;
                    labelNode.style.color = colorMap[eKey] || '#94a3b8';

                    document.getElementById('emotionConfidence').innerText =
                        `Conf: ${Math.round(emoData.confidence * 100)}% | FPS: ${emoData.engine_fps || '--'}`;

                    // Update Chart Data
                    if (emoData.raw_scores) {
                        datasets.forEach(ds => {
                            ds.data.shift(); // Remove oldest
                            const val = emoData.raw_scores[ds.label] || 0;
                            ds.data.push(val); // Add newest
                        });
                        emotionChart.update();
                    }
                }
            } catch (err) {
                console.error('API Fetch failed:', err);
                setStatusLight('apiStatus', false);
                setStatusLight('sysStatus', false);
            }
        }

        async function switchScene(sceneName) {
            const resultMsg = document.getElementById('actionResult');
            resultMsg.innerHTML = `<span class="text-indigo-400 animate-pulse">â†» åˆ‡æ›ä¸­...</span>`;
            try {
                const res = await fetch(`${API_BASE}/layout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scene_name: sceneName })
                });
                const data = await res.json();
                if (res.ok) {
                    resultMsg.innerHTML = `<span class="text-emerald-400">âœ”ï¸ æˆåŠŸ: ${data.message}</span>`;
                } else {
                    resultMsg.innerHTML = `<span class="text-red-400">âŒ å¤±æ•—: ${data.detail}</span>`;
                }
            } catch (err) {
                resultMsg.innerHTML = `<span class="text-red-400">âŒ ç¶²è·¯é€£ç·šç•°å¸¸</span>`;
            }
            setTimeout(() => resultMsg.innerHTML = '', 4000);
        }

        async function systemAction(cmd) {
            if (!confirm(`âš ï¸ ç¢ºå®šè¦åŸ·è¡Œï¼š${cmd} å—ï¼Ÿé€™å°‡æœƒå½±éŸ¿ç›®å‰æ ¸å¿ƒçš„é‹ä½œç‹€æ…‹ã€‚`)) return;
            try {
                const res = await fetch(`${API_BASE}/system`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: cmd })
                });
                const data = await res.json();
                if (res.ok) alert(`âœ”ï¸ æˆåŠŸ: ${data.message}`);
                else alert(`âŒ éŒ¯èª¤: ${data.detail}`);
            } catch (err) {
                alert(`âŒ è«‹æ±‚å¤±æ•—: ${err.message}`);
            }
        }

        // Start polling loop much faster for real-time chart (e.g. 500ms)
        setInterval(fetchStatus, 800);
        fetchStatus();
    </script>
</body>

</html>